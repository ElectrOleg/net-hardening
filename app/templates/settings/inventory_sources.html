{% extends "base.html" %}
{% block title %}Inventory Sources{% endblock %}

{% block content %}
{% set settings_section = 'Инвентарь' %}
{% include 'settings/_nav.html' %}

<div class="flex justify-between items-center mb-3">
    <div>
        <p class="text-muted text-sm">Настройка внешних источников списков устройств (БД, API, статический список)</p>
    </div>
    <button class="btn btn-primary" onclick="openCreateModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14" />
            <path d="M5 12h14" />
        </svg>
        Добавить источник
    </button>
</div>

<!-- Sources Grid -->
<div class="grid grid-3 gap-2" id="sourcesGrid">
    {% for source in sources %}
    <div class="card fade-in" data-id="{{ source.id }}">
        <div class="card-body">
            <div class="flex justify-between items-center mb-2">
                <h4 style="margin: 0;">{{ source.name }}</h4>
                {% if source.is_active %}
                <span class="badge badge-success">Active</span>
                {% else %}
                <span class="badge badge-neutral">Inactive</span>
                {% endif %}
            </div>
            <div class="text-muted text-sm mb-2">
                <code>{{ source.type }}</code>
                {% if source.sync_enabled %}
                <span class="badge badge-neutral ml-1">Sync: {{ source.sync_interval_minutes }}min</span>
                {% endif %}
            </div>
            {% if source.description %}
            <p class="text-xs text-muted mb-2">{{ source.description }}</p>
            {% endif %}
            {% if source.last_sync_at %}
            <div class="text-xs text-muted mb-2">
                Last sync: {{ source.last_sync_at.strftime('%Y-%m-%d %H:%M') if source.last_sync_at else 'Never' }}
            </div>
            {% endif %}
            <div class="flex gap-1">
                <button class="btn btn-ghost btn-sm" onclick="testSource('{{ source.id }}')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                    Test
                </button>
                <button class="btn btn-ghost btn-sm" onclick="syncSource('{{ source.id }}')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                    </svg>
                    Sync
                </button>
                <button class="btn btn-ghost btn-sm" onclick="editSource('{{ source.id }}')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </button>
                <button class="btn btn-ghost btn-sm text-danger" onclick="deleteSource('{{ source.id }}')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card" style="grid-column: span 3;">
        <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                <line x1="6" y1="6" x2="6.01" y2="6"></line>
                <line x1="6" y1="18" x2="6.01" y2="18"></line>
            </svg>
            <div>Источников инвентаря нет</div>
            <p class="text-muted text-sm">Добавьте внешний источник для получения списков устройств</p>
            <button class="btn btn-primary mt-2" onclick="openCreateModal()">Добавить первый</button>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Modal -->
<div id="sourceModal" class="modal"
    style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="card" style="width: 100%; max-width: 600px; margin: 2rem; max-height: 90vh; overflow-y: auto;">
        <div class="card-header flex justify-between items-center">
            <h3 id="modalTitle">Добавить источник</h3>
            <button class="btn btn-ghost btn-icon" onclick="closeModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="card-body">
            <input type="hidden" id="sourceId">

            <div class="form-group mb-3">
                <label>Название</label>
                <input type="text" id="sourceName" class="form-control" placeholder="CMDB PostgreSQL">
            </div>

            <div class="form-group mb-3">
                <label>Тип</label>
                <select id="sourceType" class="form-select" onchange="updateFormFields()">
                    <option value="postgres">PostgreSQL Database</option>
                    <option value="api">REST API</option>
                    <option value="static">Static List</option>
                </select>
            </div>

            <div class="form-group mb-3">
                <label>Описание</label>
                <input type="text" id="sourceDesc" class="form-control" placeholder="Продакшн CMDB">
            </div>

            <div class="form-group mb-3">
                <label>Переменная окружения для credentials</label>
                <input type="text" id="sourceCredentials" class="form-control" placeholder="CMDB_PASSWORD">
            </div>

            <div class="grid grid-2 gap-2 mb-3">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="sourceActive" checked> Активен
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="sourceSyncEnabled" checked> Авто-синхронизация
                    </label>
                </div>
            </div>

            <div class="form-group mb-3">
                <label>Интервал синхронизации (минуты)</label>
                <input type="number" id="sourceSyncInterval" class="form-control" value="60" min="5">
            </div>

            <hr style="border-color: var(--hcs-bg-tertiary); margin: 1.5rem 0;">

            <!-- PostgreSQL Fields -->
            <div id="postgresFields">
                <h4 class="mb-2">PostgreSQL параметры</h4>
                <div class="grid grid-2 gap-2">
                    <div class="form-group mb-2">
                        <label>Host</label>
                        <input type="text" id="pgHost" class="form-control" placeholder="db.example.com">
                    </div>
                    <div class="form-group mb-2">
                        <label>Port</label>
                        <input type="number" id="pgPort" class="form-control" value="5432">
                    </div>
                </div>
                <div class="grid grid-2 gap-2">
                    <div class="form-group mb-2">
                        <label>Database</label>
                        <input type="text" id="pgDatabase" class="form-control" placeholder="inventory">
                    </div>
                    <div class="form-group mb-2">
                        <label>User</label>
                        <input type="text" id="pgUser" class="form-control" placeholder="readonly">
                    </div>
                </div>
                <div class="form-group mb-2">
                    <label>Table</label>
                    <input type="text" id="pgTable" class="form-control" placeholder="devices">
                </div>
                <div class="form-group mb-2">
                    <label>Filter SQL (WHERE clause)</label>
                    <input type="text" id="pgFilter" class="form-control" placeholder="is_active = true">
                </div>
            </div>

            <!-- API Fields -->
            <div id="apiFields" style="display: none;">
                <h4 class="mb-2">API параметры</h4>
                <div class="form-group mb-2">
                    <label>Base URL</label>
                    <input type="url" id="apiBaseUrl" class="form-control" placeholder="https://cmdb.example.com/api">
                </div>
                <div class="form-group mb-2">
                    <label>Devices Endpoint</label>
                    <input type="text" id="apiEndpoint" class="form-control" placeholder="/v1/devices">
                </div>
            </div>

            <!-- Static Fields -->
            <div id="staticFields" style="display: none;">
                <h4 class="mb-2">Статический список</h4>
                <div class="form-group mb-2">
                    <label>Устройства (по одному на строку: hostname,ip,vendor)</label>
                    <textarea id="staticDevices" class="form-control" rows="5" placeholder="router1,10.0.0.1,cisco_ios
switch1,10.0.0.2,cisco_ios"></textarea>
                </div>
            </div>

            <div class="flex justify-end gap-2 mt-3">
                <button class="btn btn-secondary" onclick="closeModal()">Отмена</button>
                <button class="btn btn-primary" onclick="saveSource()">Сохранить</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const modal = document.getElementById('sourceModal');
    let isEditing = false;
    let sourcesData = {};

    {% for source in sources %}
    sourcesData['{{ source.id }}'] = {{ source.to_dict() | tojson | safe }};
    {% endfor %}

    function updateFormFields() {
        const type = document.getElementById('sourceType').value;
        document.getElementById('postgresFields').style.display = type === 'postgres' ? 'block' : 'none';
        document.getElementById('apiFields').style.display = type === 'api' ? 'block' : 'none';
        document.getElementById('staticFields').style.display = type === 'static' ? 'block' : 'none';
    }

    function openCreateModal() {
        document.getElementById('modalTitle').innerText = 'Добавить источник';
        document.getElementById('sourceId').value = '';
        document.getElementById('sourceName').value = '';
        document.getElementById('sourceType').value = 'postgres';
        document.getElementById('sourceDesc').value = '';
        document.getElementById('sourceCredentials').value = '';
        document.getElementById('sourceActive').checked = true;
        document.getElementById('sourceSyncEnabled').checked = true;
        document.getElementById('sourceSyncInterval').value = 60;
        updateFormFields();
        modal.style.display = 'flex';
        isEditing = false;
    }

    function editSource(id) {
        const source = sourcesData[id];
        if (!source) return;

        document.getElementById('modalTitle').innerText = 'Редактировать источник';
        document.getElementById('sourceId').value = id;
        document.getElementById('sourceName').value = source.name;
        document.getElementById('sourceType').value = source.type;
        document.getElementById('sourceDesc').value = source.description || '';
        document.getElementById('sourceCredentials').value = source.credentials_ref || '';
        document.getElementById('sourceActive').checked = source.is_active;
        document.getElementById('sourceSyncEnabled').checked = source.sync_enabled;
        document.getElementById('sourceSyncInterval').value = source.sync_interval_minutes;

        const params = source.connection_params || {};

        if (source.type === 'postgres') {
            document.getElementById('pgHost').value = params.host || '';
            document.getElementById('pgPort').value = params.port || 5432;
            document.getElementById('pgDatabase').value = params.database || '';
            document.getElementById('pgUser').value = params.user || '';
            document.getElementById('pgTable').value = params.table || 'devices';
            document.getElementById('pgFilter').value = params.filter_sql || '';
        }
        if (source.type === 'api') {
            document.getElementById('apiBaseUrl').value = params.base_url || '';
            document.getElementById('apiEndpoint').value = params.endpoint || '';
        }
        if (source.type === 'static') {
            document.getElementById('staticDevices').value = (params.devices || []).map(d =>
                `${d.hostname},${d.ip_address || ''},${d.vendor_code || ''}`
            ).join('\n');
        }

        updateFormFields();
        modal.style.display = 'flex';
        isEditing = true;
    }

    function closeModal() {
        modal.style.display = 'none';
    }

    function getConnectionParams() {
        const type = document.getElementById('sourceType').value;
        let params = {};

        if (type === 'postgres') {
            params = {
                host: document.getElementById('pgHost').value,
                port: parseInt(document.getElementById('pgPort').value) || 5432,
                database: document.getElementById('pgDatabase').value,
                user: document.getElementById('pgUser').value,
                table: document.getElementById('pgTable').value,
                filter_sql: document.getElementById('pgFilter').value || null
            };
        } else if (type === 'api') {
            params = {
                base_url: document.getElementById('apiBaseUrl').value,
                endpoint: document.getElementById('apiEndpoint').value
            };
        } else if (type === 'static') {
            const lines = document.getElementById('staticDevices').value.split('\n').filter(l => l.trim());
            params = {
                devices: lines.map(line => {
                    const [hostname, ip, vendor] = line.split(',').map(s => s.trim());
                    return { hostname, ip_address: ip || null, vendor_code: vendor || null };
                })
            };
        }

        return params;
    }

    async function saveSource() {
        const id = document.getElementById('sourceId').value;
        const data = {
            name: document.getElementById('sourceName').value,
            type: document.getElementById('sourceType').value,
            description: document.getElementById('sourceDesc').value || null,
            credentials_ref: document.getElementById('sourceCredentials').value || null,
            is_active: document.getElementById('sourceActive').checked,
            sync_enabled: document.getElementById('sourceSyncEnabled').checked,
            sync_interval_minutes: parseInt(document.getElementById('sourceSyncInterval').value) || 60,
            connection_params: getConnectionParams()
        };

        if (!data.name) {
            showNotification('Введите название', 'warning');
            return;
        }

        const url = isEditing ? `/api/inventory-sources/${id}` : '/api/inventory-sources';
        const method = isEditing ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showNotification('Сохранено', 'success');
                window.location.reload();
            } else {
                const err = await response.json();
                showNotification('Ошибка: ' + (err.error || 'Unknown'), 'danger');
            }
        } catch (e) {
            showNotification('Ошибка: ' + e.message, 'danger');
        }
    }

    async function testSource(id) {
        showNotification('Тестирование...', 'info');
        try {
            const response = await fetch(`/api/inventory-sources/${id}/test`, { method: 'POST' });
            const result = await response.json();

            if (result.success) {
                showNotification('Подключение успешно: ' + result.message, 'success');
            } else {
                showNotification('Ошибка: ' + result.message, 'danger');
            }
        } catch (e) {
            showNotification('Ошибка: ' + e.message, 'danger');
        }
    }

    async function syncSource(id) {
        showNotification('Синхронизация...', 'info');
        try {
            const response = await fetch(`/api/inventory-sources/${id}/sync`, { method: 'POST' });
            const result = await response.json();

            if (result.success) {
                showNotification(result.message, 'success');
                window.location.reload();
            } else {
                showNotification('Ошибка: ' + result.message, 'danger');
            }
        } catch (e) {
            showNotification('Ошибка: ' + e.message, 'danger');
        }
    }

    async function deleteSource(id) {
        if (!confirm('Удалить этот источник инвентаря?')) return;

        try {
            const response = await fetch(`/api/inventory-sources/${id}`, { method: 'DELETE' });
            if (response.ok) {
                showNotification('Удалено', 'success');
                window.location.reload();
            } else {
                showNotification('Ошибка при удалении', 'danger');
            }
        } catch (e) {
            showNotification('Ошибка: ' + e.message, 'danger');
        }
    }

    window.onclick = function (event) {
        if (event.target == modal) closeModal();
    }
</script>
{% endblock %}