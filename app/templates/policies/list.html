{% extends "base.html" %}
{% block title %}Policies{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-3">
    <h2>Политики</h2>
    <button class="btn btn-primary" onclick="createPolicy()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14" />
            <path d="M5 12h14" />
        </svg>
        Создать политику
    </button>
</div>

<div class="grid grid-3 gap-2">
    {% for policy in policies %}
    <div class="card fade-in" style="animation-delay: {{ loop.index * 50 }}ms;">
        <div class="card-body">
            <div class="flex justify-between items-center mb-2">
                <h4 style="margin: 0;">{{ policy.name }}</h4>
                {% if policy.severity == 'critical' %}
                <span class="badge badge-danger">critical</span>
                {% elif policy.severity == 'high' %}
                <span class="badge badge-warning">high</span>
                {% else %}
                <span class="badge badge-neutral">{{ policy.severity }}</span>
                {% endif %}
            </div>
            <p class="text-muted text-sm" style="margin-bottom: 1rem;">
                {{ policy.description or 'Без описания' }}
            </p>
            <div class="flex justify-between items-center">
                <span class="text-sm">
                    <strong>{{ policy.rules.count() }}</strong> правил
                </span>
                <button class="btn btn-ghost btn-icon" onclick="editPolicy('{{ policy.id }}')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7" />
                        <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card" style="grid-column: span 3;">
        <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z" />
            </svg>
            <div>Политик пока нет</div>
            <button class="btn btn-primary mt-2" onclick="createPolicy()">Создать первую</button>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function createPolicy() {
        const name = prompt('Название политики:');
        if (!name) return;

        const description = prompt('Описание:') || '';

        try {
            const response = await fetch('/api/policies', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, description, severity: 'medium' })
            });

            if (response.ok) {
                window.location.reload();
            } else {
                const data = await response.json();
                showNotification('Ошибка: ' + data.error, 'danger');
            }
        } catch (e) {
            showNotification('Ошибка: ' + e.message, 'danger');
        }
    }

    function editPolicy(policyId) {
        // TODO: Open edit modal
        alert('Edit policy: ' + policyId);
    }
</script>
{% endblock %}