{% extends "base.html" %}
{% block title %}Rule Builder{% endblock %}

{% block extra_css %}
<style>
    /* Modern UI Variables */
    :root {
        --switch-width: 46px;
        --switch-height: 24px;
        --switch-thumb-size: 18px;
    }

    .builder-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }

    @media (max-width: 1024px) {
        .builder-grid {
            grid-template-columns: 1fr;
        }
    }

    .payload-editor {
        font-family: 'JetBrains Mono', monospace;
        min-height: 300px;
        font-size: 0.9em;
        line-height: 1.5;
        background-color: var(--hcs-bg-secondary);
        border: 1px solid var(--hcs-border);
        border-radius: var(--hcs-radius-md);
    }

    .test-result {
        max-height: 300px;
        overflow-y: auto;
    }

    /* Modern Toggle Switch */
    .toggle-switch {
        position: relative;
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        gap: 0.75rem;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: relative;
        width: var(--switch-width);
        height: var(--switch-height);
        background-color: var(--hcs-border);
        /* Inactive color */
        border-radius: 34px;
        transition: .3s cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: var(--switch-thumb-size);
        width: var(--switch-thumb-size);
        left: 3px;
        bottom: 3px;
        background-color: white;
        border-radius: 50%;
        transition: .3s cubic-bezier(0.4, 0.0, 0.2, 1);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .toggle-switch input:checked+.toggle-slider {
        background-color: var(--hcs-primary);
    }

    .toggle-switch input:checked+.toggle-slider:before {
        transform: translateX(22px);
    }

    /* Visual Builder Modern Container */
    .visual-builder-container {
        background: var(--hcs-bg-secondary);
        padding: 1.5rem;
        border-radius: var(--hcs-radius-lg);
        border: 1px solid var(--hcs-border);
        position: relative;
    }

    .visual-label {
        font-weight: 500;
        color: var(--hcs-text-secondary);
        letter-spacing: 0.02em;
        text-transform: uppercase;
        font-size: 0.75rem;
        margin-bottom: 0.5rem;
    }

    /* Input Group Modernization */
    .modern-input-group {
        display: flex;
        border: 1px solid var(--hcs-border);
        border-radius: var(--hcs-radius-md);
        overflow: hidden;
        transition: border-color 0.2s;
    }

    .modern-input-group:focus-within {
        border-color: var(--hcs-primary);
        box-shadow: 0 0 0 2px rgba(var(--hcs-primary-rgb), 0.1);
    }

    .modern-input-group .input-group-text {
        background: var(--hcs-bg-tertiary);
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        color: var(--hcs-text-muted);
        border-right: 1px solid var(--hcs-border);
        white-space: nowrap;
    }

    .modern-input-group .form-input {
        border: none;
        box-shadow: none;
        border-radius: 0;
        padding-left: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-4">
    <div class="flex items-center gap-3">
        <a href="{{ url_for('web.rules_list') }}" class="btn btn-ghost btn-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6" />
            </svg>
        </a>
        <div>
            <h2 class="text-xl font-bold">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ø—Ä–∞–≤–∏–ª</h2>
            <p class="text-sm text-muted">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∏ —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</p>
        </div>
    </div>
</div>

<div class="builder-grid">
    <!-- Rule Form -->
    <div class="card fade-in">
        <div class="card-header flex justify-between items-center pb-0 border-b-0">
            <h4 class="m-0 text-lg">–ù–∞—Å—Ç—Ä–æ–π–∫–∞</h4>

            <!-- Integrated Modern Toggle -->
            <label class="toggle-switch" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤ —Ä–µ–∂–∏–º —Ä—É—á–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è JSON">
                <input type="checkbox" id="manualModeToggle" onchange="toggleManualMode()">
                <span class="toggle-slider"></span>
                <span class="text-xs font-medium text-muted uppercase tracking-wider">JSON Mode</span>
            </label>
        </div>

        <div class="card-body pt-2">
            <form id="ruleForm">
                <div class="form-group mb-4">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞</label>
                    <input type="text" class="form-input text-lg font-medium" id="title"
                        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞–ø—Ä–µ—Ç Telnet" required>
                </div>

                <div class="grid grid-2 gap-4 mb-4">
                    <div class="form-group">
                        <label class="form-label">–ü–æ–ª–∏—Ç–∏–∫–∞</label>
                        <select class="form-select" id="policy_id" required>
                            {% for policy in policies %}
                            <option value="{{ policy.id }}">{{ policy.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–í–µ–Ω–¥–æ—Ä</label>
                        <select class="form-select" id="vendor_code" required>
                            {% for vendor in vendors %}
                            <option value="{{ vendor.code }}">{{ vendor.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="form-group mb-6">
                    <label class="form-label">–¢–∏–ø –ø—Ä–æ–≤–µ—Ä–∫–∏</label>
                    <select class="form-select" id="logic_type" onchange="updateBuilderMode()"
                        style="font-weight: 500; color: var(--hcs-primary);">
                        <option value="simple_match">Simple Match (Regex Search)</option>
                        <option value="block_match">Block Context Match</option>
                        <option value="structure_check">Structure Check (JSON Query)</option>
                        <option value="version_check">Version Check</option>
                        <option value="textfsm_check">TextFSM Check</option>
                        <option value="xml_check">XML/XPath Check</option>
                    </select>
                </div>

                <hr class="border-t border-gray-100 dark:border-gray-800 mb-6" />

                <!-- VISUAL BUILDER UI -->
                <div id="visualBuilder" class="visual-builder-container mb-4">

                    <!-- 1. Simple Match Form -->
                    <div id="form_simple_match" class="logic-form" style="display: none;">
                        <div class="form-group mb-4">
                            <label class="visual-label">1. –ò—Å–∫–æ–º—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω</label>
                            <div class="modern-input-group">
                                <span class="input-group-text">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </span>
                                <input type="text" class="form-input" id="sm_pattern"
                                    placeholder="e.g. ^service password-encryption">
                            </div>
                        </div>

                        <div class="grid grid-2 gap-4">
                            <div class="form-group">
                                <label class="visual-label">2. –û–∂–∏–¥–∞–µ–º–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</label>
                                <select class="form-select" id="sm_mode">
                                    <option value="must_exist">‚úÖ –î–æ–ª–∂–Ω–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å (Required)</option>
                                    <option value="must_not_exist">üö´ –ù–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å (Forbidden)</option>
                                </select>
                            </div>

                            <div class="flex flex-col gap-3 justify-center">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="sm_regex" checked>
                                    <span class="toggle-slider"></span>
                                    <span class="text-sm">Regex (–†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è)</span>
                                </label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="sm_case">
                                    <span class="toggle-slider"></span>
                                    <span class="text-sm">–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä (Case Insensitive)</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Block Match Form -->
                    <div id="form_block_match" class="logic-form" style="display: none;">
                        <div class="grid grid-2 gap-3 mb-3">
                            <div class="form-group">
                                <label class="visual-label">–ù–∞—á–∞–ª–æ –±–ª–æ–∫–∞ (Regex)</label>
                                <input type="text" class="form-input" id="bm_parent" placeholder="^interface (Gi|Te)">
                            </div>
                            <div class="form-group">
                                <label class="visual-label">–ö–æ–Ω–µ—Ü –±–ª–æ–∫–∞ (Regex) <span
                                        class="text-muted lowercase font-normal">(–æ–ø—Ü.)</span></label>
                                <input type="text" class="form-input" id="bm_end" placeholder="^!">
                            </div>
                        </div>

                        <div class="form-group mb-4">
                            <label class="visual-label">–ò—Å–∫–ª—é—á–∏—Ç—å –±–ª–æ–∫–∏ (Filter)</label>
                            <input type="text" class="form-input" id="bm_exclude"
                                placeholder="e.g. description .*UPLINK.*">
                            <small class="text-muted block mt-1">–ù–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –±–ª–æ–∫–∏, –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø–æ–¥ —ç—Ç–æ—Ç pattern</small>
                        </div>

                        <div
                            class="bg-white dark:bg-gray-800 p-3 rounded-md border border-gray-200 dark:border-gray-700 mb-4">
                            <label class="visual-label mb-2 block">–í–ª–æ–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (Child Rules)</label>
                            <div id="bm_children_container" class="flex flex-col gap-2 mb-3">
                                <!-- JS Generated -->
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary w-full border-dashed"
                                onclick="addBlockChildRow()">
                                + –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É
                            </button>
                        </div>

                        <div class="form-group">
                            <label class="visual-label">–õ–æ–≥–∏–∫–∞</label>
                            <select class="form-select" id="bm_logic">
                                <option value="ALL">ALL ‚Äî –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞—Å—Ç—å</option>
                                <option value="ANY">ANY ‚Äî –•–æ—Ç—è –±—ã –æ–¥–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–≤–ø–∞—Å—Ç—å</option>
                            </select>
                        </div>
                    </div>

                    <!-- 3. Structure Check Form -->
                    <div id="form_structure_check" class="logic-form" style="display: none;">
                        <div class="form-group mb-4">
                            <label class="visual-label">JMESPath Query</label>
                            <div class="modern-input-group">
                                <span class="input-group-text">$.</span>
                                <input type="text" class="form-input" id="sc_path"
                                    placeholder="network.interfaces[?name=='eth0'].enabled">
                            </div>
                        </div>
                        <div class="grid grid-2 gap-4">
                            <div class="form-group">
                                <label class="visual-label">–û–ø–µ—Ä–∞—Ç–æ—Ä</label>
                                <select class="form-select" id="sc_operator" onchange="toggleScValue()">
                                    <option value="eq">== –†–∞–≤–Ω–æ</option>
                                    <option value="neq">!= –ù–µ —Ä–∞–≤–Ω–æ</option>
                                    <option value="contains">‚àã –°–æ–¥–µ—Ä–∂–∏—Ç</option>
                                    <option value="exists">‚àÉ –°—É—â–µ—Å—Ç–≤—É–µ—Ç</option>
                                    <option value="not_exists">‚àÑ –ù–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç</option>
                                    <option value="gt">&gt; –ë–æ–ª—å—à–µ</option>
                                    <option value="lt">&lt; –ú–µ–Ω—å—à–µ</option>
                                </select>
                            </div>
                            <div class="form-group" id="sc_value_group">
                                <label class="visual-label">–ó–Ω–∞—á–µ–Ω–∏–µ</label>
                                <input type="text" class="form-input" id="sc_value" placeholder="true">
                            </div>
                        </div>
                    </div>

                    <!-- 4. Version Check Form -->
                    <div id="form_version_check" class="logic-form" style="display: none;">
                        <div class="form-group mb-4">
                            <label class="visual-label">Regex –ø–∞—Ç—Ç–µ—Ä–Ω –≤–µ—Ä—Å–∏–∏</label>
                            <div class="modern-input-group">
                                <span class="input-group-text">v</span>
                                <input type="text" class="form-input" id="vc_pattern"
                                    placeholder="version (\d+\.\d+\.\d+)">
                            </div>
                        </div>
                        <div class="grid grid-2 gap-4">
                            <div class="form-group">
                                <label class="visual-label">–û–ø–µ—Ä–∞—Ç–æ—Ä</label>
                                <select class="form-select" id="vc_operator">
                                    <option value="ge">>= –ë–æ–ª—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–æ</option>
                                    <option value="eq">== –†–∞–≤–Ω–æ</option>
                                    <option value="le">
                                        <= –ú–µ–Ω—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–æ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="visual-label">–¢—Ä–µ–±—É–µ–º–∞—è –≤–µ—Ä—Å–∏—è</label>
                                <input type="text" class="form-input" id="vc_value" placeholder="15.2.4">
                            </div>
                        </div>
                    </div>

                    <!-- Placeholder -->
                    <div id="form_generic" class="logic-form flex flex-col items-center justify-center p-8 text-center"
                        style="display: none;">
                        <svg class="text-muted mb-2" width="32" height="32" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="1.5">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        <p class="text-sm text-muted">–î–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∂–∏–º <strong>JSON</strong>
                        </p>
                    </div>
                </div>

                <!-- MANUAL JSON EDITOR -->
                <div class="form-group fade-in" id="jsonPayloadGroup" style="display: none;">
                    <label class="form-label font-mono text-xs text-muted mb-2 block">RAW JSON PAYLOAD</label>
                    <textarea class="form-textarea payload-editor" id="logic_payload" required></textarea>
                </div>

                <div class="grid grid-2 gap-4 mt-6">
                    <div class="form-group">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (Optional)</label>
                        <textarea class="form-textarea" id="description" rows="2"
                            placeholder="–î–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Remediation (Optional)</label>
                        <textarea class="form-textarea" id="remediation" rows="2"
                            placeholder="–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è..."></textarea>
                    </div>
                </div>
            </form>
        </div>
        <div class="card-footer flex justify-between bg-transparent border-t border-gray-100 dark:border-gray-800">
            <button class="btn btn-ghost" type="button" onclick="history.back()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary px-6" type="button" onclick="saveRule()">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ
            </button>
        </div>
    </div>

    <!-- Live Test Sandbox -->
    <div class="card fade-in" style="animation-delay: 100ms; height: fit-content; position: sticky; top: 1rem;">
        <div class="card-header flex justify-between items-center pb-2">
            <div>
                <h4 class="m-0">Live Sandbox</h4>
                <p class="text-xs text-muted m-0">–ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª–æ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å</p>
            </div>
            <button class="btn btn-success btn-sm flex items-center gap-2" type="button" onclick="testRule()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3" />
                </svg>
                Run Test
            </button>
        </div>
        <div class="card-body">
            <div class="flex justify-end mb-2">
                <button class="text-xs text-primary hover:underline bg-transparent border-0 cursor-pointer"
                    onclick="loadSampleConfig()">
                    –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥–∞
                </button>
            </div>
            <div class="form-group mb-4">
                <textarea class="form-textarea font-mono text-xs leading-relaxed" id="test_config" rows="20"
                    placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞..."
                    style="background: var(--hcs-bg-tertiary); border: none;"></textarea>
            </div>

            <div id="testResult"
                class="test-result p-3 rounded bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 shadow-sm"
                style="display: none;">
                <label class="text-xs font-bold uppercase text-muted mb-2 block">–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</label>
                <div id="testResultContent"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initial templates for JSON Mode fallback
    const PAYLOAD_TEMPLATES = {
        simple_match: { pattern: "^service password-encryption", match_mode: "must_exist", is_regex: true },
        block_match: { parent_block_start: "^interface Gi", child_rules: [{ pattern: "no ip redirects", mode: "must_exist" }] },
        structure_check: { path: "network.interfaces", operator: "eq", value: "up" },
        version_check: { pattern: "version (\\d+)", operator: "ge", value: "15.0" }
    };

    let isManualMode = false;

    // --- Core Lifecycle ---

    function initBuilder() {
        updateBuilderMode();

        // Listeners for auto-updating JSON from Visual Fields
        const inputs = document.querySelectorAll('#visualBuilder input, #visualBuilder select');
        inputs.forEach(input => {
            input.addEventListener('input', syncVisualToJson);
        });
    }

    function toggleManualMode() {
        isManualMode = document.getElementById('manualModeToggle').checked;
        const visualBuilder = document.getElementById('visualBuilder');
        const jsonGroup = document.getElementById('jsonPayloadGroup');

        if (isManualMode) {
            visualBuilder.style.display = 'none';
            jsonGroup.style.display = 'block';
        } else {
            // Try to parse JSON back to visual
            trySyncJsonToVisual();
            visualBuilder.style.display = 'block';
            jsonGroup.style.display = 'none';
        }
    }

    function updateBuilderMode() {
        const type = document.getElementById('logic_type').value;

        // Hide all forms
        document.querySelectorAll('.logic-form').forEach(el => el.style.display = 'none');

        // Show specific form
        const formId = `form_${type}`;
        const form = document.getElementById(formId);
        if (form) {
            form.style.display = 'block';
        } else {
            document.getElementById('form_generic').style.display = 'flex'; // Flex for centering
        }

        // Initialize default JSON if empty
        const jsonVal = document.getElementById('logic_payload').value.trim();
        if (!jsonVal && PAYLOAD_TEMPLATES[type]) {
            document.getElementById('logic_payload').value = JSON.stringify(PAYLOAD_TEMPLATES[type], null, 2);
            trySyncJsonToVisual(); // Populate visual fields from template
        }
    }

    // --- Sync Logic: Visual -> JSON ---

    function syncVisualToJson() {
        if (isManualMode) return;

        const type = document.getElementById('logic_type').value;
        let payload = {};

        try {
            if (type === 'simple_match') {
                payload = {
                    pattern: document.getElementById('sm_pattern').value,
                    match_mode: document.getElementById('sm_mode').value,
                    is_regex: document.getElementById('sm_regex').checked,
                    case_insensitive: document.getElementById('sm_case').checked
                };
            } else if (type === 'block_match') {
                payload = {
                    parent_block_start: document.getElementById('bm_parent').value,
                    parent_block_end: document.getElementById('bm_end').value || null,
                    exclude_filter: document.getElementById('bm_exclude').value || null,
                    logic: document.getElementById('bm_logic').value,
                    child_rules: getBlockChildRules()
                };
            } else if (type === 'structure_check') {
                payload = {
                    path: document.getElementById('sc_path').value,
                    operator: document.getElementById('sc_operator').value,
                    value: document.getElementById('sc_value').value
                };
                if (payload.operator.includes('exists')) delete payload.value;
            } else if (type === 'version_check') {
                payload = {
                    pattern: document.getElementById('vc_pattern').value,
                    operator: document.getElementById('vc_operator').value,
                    value: document.getElementById('vc_value').value,
                    version_group: 1
                };
            } else {
                return; // Unsupported type for visual builder
            }

            document.getElementById('logic_payload').value = JSON.stringify(payload, null, 2);
        } catch (e) {
            console.error("Sync error", e);
        }
    }

    // --- Sync Logic: JSON -> Visual ---

    function trySyncJsonToVisual() {
        const type = document.getElementById('logic_type').value;
        const jsonStr = document.getElementById('logic_payload').value;

        try {
            const payload = JSON.parse(jsonStr);

            if (type === 'simple_match') {
                document.getElementById('sm_pattern').value = payload.pattern || '';
                document.getElementById('sm_mode').value = payload.match_mode || 'must_exist';
                document.getElementById('sm_regex').checked = payload.is_regex !== false; // Default true if undefined
                document.getElementById('sm_case').checked = !!payload.case_insensitive;
            } else if (type === 'block_match') {
                document.getElementById('bm_parent').value = payload.parent_block_start || '';
                document.getElementById('bm_end').value = payload.parent_block_end || '';
                document.getElementById('bm_exclude').value = payload.exclude_filter || '';
                document.getElementById('bm_logic').value = payload.logic || 'ALL';

                // Rebuild children
                const container = document.getElementById('bm_children_container');
                container.innerHTML = '';
                if (payload.child_rules && Array.isArray(payload.child_rules)) {
                    payload.child_rules.forEach(rule => addBlockChildRow(rule.pattern, rule.mode));
                } else {
                    addBlockChildRow(); // Add empty row
                }
            } else if (type === 'structure_check') {
                document.getElementById('sc_path').value = payload.path || '';
                document.getElementById('sc_operator').value = payload.operator || 'eq';
                document.getElementById('sc_value').value = payload.value || '';
                toggleScValue();
            } else if (type === 'version_check') {
                document.getElementById('vc_pattern').value = payload.pattern || '';
                document.getElementById('vc_operator').value = payload.operator || 'ge';
                document.getElementById('vc_value').value = payload.value || '';
            }

        } catch (e) {
            console.warn("Could not parse JSON to Visual", e);
            // Don't clear fields, just fail silently as user might be typing invalid JSON
        }
    }

    // --- Helper Functions ---

    function addBlockChildRow(pattern = '', mode = 'must_exist') {
        const container = document.getElementById('bm_children_container');
        const div = document.createElement('div');
        div.className = 'grid grid-2 gap-2 p-2 bg-gray-50 dark:bg-gray-700/50 rounded items-center border border-gray-100 dark:border-gray-700';
        div.style.gridTemplateColumns = '2fr 1fr auto';

        div.innerHTML = `
            <input type="text" class="form-input bm-child-pattern" placeholder="Pattern inside block" value="${pattern.replace(/"/g, '&quot;')}" oninput="syncVisualToJson()">
            <select class="form-select bm-child-mode" onchange="syncVisualToJson()">
                <option value="must_exist" ${mode === 'must_exist' ? 'selected' : ''}>Must Exist</option>
                <option value="must_not_exist" ${mode === 'must_not_exist' ? 'selected' : ''}>Forbidden</option>
            </select>
            <button type="button" class="btn btn-ghost btn-sm text-danger h-full flex items-center justify-center aspect-square" onclick="this.parentElement.remove(); syncVisualToJson()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
        `;
        container.appendChild(div);

        // Add listeners to new elements
        div.querySelectorAll('input, select').forEach(el => el.addEventListener('input', syncVisualToJson));
        syncVisualToJson();
    }

    function getBlockChildRules() {
        const rows = document.querySelectorAll('#bm_children_container > div');
        return Array.from(rows).map(row => ({
            pattern: row.querySelector('.bm-child-pattern').value,
            mode: row.querySelector('.bm-child-mode').value
        })).filter(r => r.pattern.trim() !== '');
    }

    function toggleScValue() {
        const op = document.getElementById('sc_operator').value;
        const noValOps = ['exists', 'not_exists'];
        document.getElementById('sc_value_group').style.display = noValOps.includes(op) ? 'none' : 'block';
        syncVisualToJson();
    }

    function loadSampleConfig() {
        const conf = `! Example Cisco IOS Config
version 15.2
service timestamps debug datetime msec
service timestamps log datetime msec
no service password-encryption
!
hostname Router01
!
interface GigabitEthernet1
 description EXTERNAL_UPLINK
 ip address 192.168.1.1 255.255.255.0
 no ip redirects
 no ip proxy-arp
 negotiation auto
!
interface GigabitEthernet2
 description INTERNAL_LAN
 ip address 10.0.0.1 255.255.255.0
 ip proxy-arp
!
line vty 0 4
 transport input ssh
!
end`;
        document.getElementById('test_config').value = conf;
    }

    // --- Existing API Functions (modified) ---

    async function testRule() {
        // Ensure JSON is up to date (if in visual mode)
        syncVisualToJson();

        const config = document.getElementById('test_config').value;
        if (!config.trim()) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏', 'warning');
            loadSampleConfig();
            return;
        }

        const logicType = document.getElementById('logic_type').value;
        let logicPayload;

        try {
            logicPayload = JSON.parse(document.getElementById('logic_payload').value);
        } catch (e) {
            showNotification('–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π Payload', 'danger');
            return;
        }

        const resultDiv = document.getElementById('testResult');
        const resultContent = document.getElementById('testResultContent');

        resultDiv.style.display = 'block';
        resultContent.innerHTML = '<div class="text-sm text-muted animate-pulse">Running checks...</div>';

        try {
            const response = await fetch('/api/test/rule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    config: config,
                    logic_type: logicType,
                    logic_payload: logicPayload
                })
            });

            const data = await response.json();

            let html = '';
            if (data.passed) {
                html = `<div class="p-3 bg-green-50 text-green-800 rounded border border-green-200 flex items-center gap-2">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                <strong>PASS:</strong> ${data.message}
            </div>`;
            } else if (data.status === 'ERROR') {
                html = `<div class="p-3 bg-yellow-50 text-yellow-800 rounded border border-yellow-200">
                <strong>‚ö† ERROR:</strong> ${data.message}
            </div>`;
            } else {
                html = `<div class="p-3 bg-red-50 text-red-800 rounded border border-red-200">
                <div class="flex items-center gap-2 mb-1">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                    <strong>FAIL:</strong> ${data.message}
                </div>
            </div>`;
                if (data.diff_data) {
                    html += `<pre class="mt-2 text-xs bg-gray-900 text-gray-100 p-2 rounded overflow-x-auto">${data.diff_data}</pre>`;
                }
            }
            resultContent.innerHTML = html;

        } catch (e) {
            resultContent.innerHTML = `<div class="text-danger">–û—à–∏–±–∫–∞: ${e.message}</div>`;
        }
    }

    async function saveRule() {
        syncVisualToJson();

        let logicPayload;
        try {
            logicPayload = JSON.parse(document.getElementById('logic_payload').value);
        } catch (e) {
            showNotification('–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON –≤ payload', 'danger');
            return;
        }

        const rule = {
            title: document.getElementById('title').value,
            policy_id: document.getElementById('policy_id').value,
            vendor_code: document.getElementById('vendor_code').value,
            logic_type: document.getElementById('logic_type').value,
            logic_payload: logicPayload,
            description: document.getElementById('description').value,
            remediation: document.getElementById('remediation').value
        };

        if (!rule.title) return showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'warning');

        try {
            const url = window.location.search.includes('edit')
                ? `/api/rules/${new URLSearchParams(window.location.search).get('edit')}`
                : '/api/rules';
            const method = window.location.search.includes('edit') ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(rule)
            });

            const data = await response.json();

            if (response.ok) {
                showNotification('–ü—Ä–∞–≤–∏–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!', 'success');
                setTimeout(() => window.location.href = '/rules', 1000);
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'danger');
            }
        } catch (e) {
            showNotification('–û—à–∏–±–∫–∞: ' + e.message, 'danger');
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
        initBuilder();

        // Check for edit/clone params
        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('edit') || urlParams.get('clone');

        if (editId) {
            try {
                const response = await fetch(`/api/rules/${editId}`);
                if (response.ok) {
                    const rule = await response.json();

                    document.getElementById('title').value = rule.title + (urlParams.get('clone') ? " (Copy)" : "");
                    document.getElementById('policy_id').value = rule.policy_id;
                    document.getElementById('vendor_code').value = rule.vendor_code;
                    document.getElementById('logic_type').value = rule.logic_type;
                    document.getElementById('description').value = rule.description || '';
                    document.getElementById('remediation').value = rule.remediation || '';

                    if (rule.logic_payload) {
                        document.getElementById('logic_payload').value = JSON.stringify(rule.logic_payload, null, 2);
                        updateBuilderMode(); // Re-trigger visual sync
                    }
                }
            } catch (e) { console.error(e); }
        } else {
            // New rule defaults
            loadSampleConfig();
        }
    });
</script>
{% endblock %}