{% extends "base.html" %}
{% block title %}Rule Builder{% endblock %}

{% block extra_css %}
<style>
    :root {
        --switch-width: 46px;
        --switch-height: 24px;
        --switch-thumb-size: 18px;
    }

    .builder-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }

    @media (max-width: 1024px) {
        .builder-grid {
            grid-template-columns: 1fr;
        }
    }

    /* ‚îÄ‚îÄ Type Selector Cards ‚îÄ‚îÄ */
    .type-cards-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.625rem;
    }

    @media (max-width: 600px) {
        .type-cards-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    .type-card {
        background: var(--hcs-bg-primary);
        border: 1.5px solid var(--hcs-bg-tertiary);
        border-radius: var(--hcs-radius-md);
        padding: 0.75rem;
        cursor: pointer;
        transition: all 0.25s cubic-bezier(.4, 0, .2, 1);
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .type-card:hover {
        border-color: var(--hcs-accent);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .type-card.active {
        border-color: var(--hcs-accent);
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%);
        box-shadow: 0 0 0 3px var(--hcs-accent-glow), 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .type-card-icon {
        width: 32px;
        height: 32px;
        margin: 0 auto 0.375rem;
        color: var(--hcs-text-muted);
        transition: color 0.2s;
    }

    .type-card.active .type-card-icon {
        color: var(--hcs-accent-light);
    }

    .type-card-title {
        font-size: 0.8125rem;
        font-weight: 600;
        color: var(--hcs-text-primary);
        margin-bottom: 0.125rem;
    }

    .type-card-desc {
        font-size: 0.6875rem;
        color: var(--hcs-text-muted);
        line-height: 1.3;
    }

    /* ‚îÄ‚îÄ Severity Badges ‚îÄ‚îÄ */
    .severity-options {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .severity-btn {
        padding: 0.375rem 0.875rem;
        border-radius: 100px;
        border: 1.5px solid var(--hcs-bg-tertiary);
        background: transparent;
        color: var(--hcs-text-secondary);
        font-size: 0.8125rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .severity-btn:hover {
        border-color: var(--color, var(--hcs-accent));
    }

    .severity-btn.active {
        border-color: var(--color);
        background: var(--bg);
        color: var(--color);
    }

    /* ‚îÄ‚îÄ Step Indicator ‚îÄ‚îÄ */
    .step-label {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        color: var(--hcs-text-secondary);
        letter-spacing: 0.02em;
        text-transform: uppercase;
        font-size: 0.75rem;
        margin-bottom: 0.5rem;
    }

    .step-num {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--hcs-accent);
        color: white;
        font-size: 0.6875rem;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    /* ‚îÄ‚îÄ Field Hint ‚îÄ‚îÄ */
    .field-hint {
        font-size: 0.75rem;
        color: var(--hcs-text-muted);
        margin-top: 0.375rem;
        padding-left: 0.25rem;
        line-height: 1.4;
    }

    .field-hint code {
        background: var(--hcs-bg-tertiary);
        padding: 0.125rem 0.375rem;
        border-radius: 3px;
        font-size: 0.6875rem;
        font-family: 'JetBrains Mono', monospace;
    }

    /* ‚îÄ‚îÄ Payload Editor ‚îÄ‚îÄ */
    .payload-editor {
        font-family: 'JetBrains Mono', monospace;
        min-height: 300px;
        font-size: 0.85em;
        line-height: 1.5;
        background-color: var(--hcs-bg-primary);
        border: 1px solid var(--hcs-bg-tertiary);
        border-radius: var(--hcs-radius-md);
        color: var(--hcs-text-primary);
    }

    .payload-editor:focus {
        outline: none;
        border-color: var(--hcs-accent);
    }

    .test-result {
        max-height: 350px;
        overflow-y: auto;
    }

    /* ‚îÄ‚îÄ Toggle Switch ‚îÄ‚îÄ */
    .toggle-switch {
        position: relative;
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        gap: 0.75rem;
        user-select: none;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
        position: absolute;
        margin: 0;
    }

    .toggle-slider {
        position: relative;
        display: inline-block;
        width: var(--switch-width);
        min-width: var(--switch-width);
        height: var(--switch-height);
        background-color: var(--hcs-bg-tertiary);
        border: 1px solid var(--hcs-bg-tertiary);
        border-radius: 34px;
        transition: .3s cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: var(--switch-thumb-size);
        width: var(--switch-thumb-size);
        left: 2px;
        bottom: 2px;
        background-color: var(--hcs-text-secondary);
        border-radius: 50%;
        transition: .3s cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    .toggle-switch input:checked+.toggle-slider {
        background-color: var(--hcs-accent);
        border-color: var(--hcs-accent);
    }

    .toggle-switch input:checked+.toggle-slider:before {
        transform: translateX(20px);
        background-color: white;
    }

    /* ‚îÄ‚îÄ Visual Builder ‚îÄ‚îÄ */
    .visual-builder-container {
        background: var(--hcs-bg-primary);
        padding: 1.5rem;
        border-radius: var(--hcs-radius-lg);
        border: 1px solid var(--hcs-bg-tertiary);
        position: relative;
        transition: opacity 0.3s, transform 0.3s;
    }

    .logic-form {
        animation: fadeSlideIn 0.3s ease;
    }

    @keyframes fadeSlideIn {
        from {
            opacity: 0;
            transform: translateY(8px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .nested-group-container {
        background: var(--hcs-bg-secondary);
        padding: 1rem;
        border-radius: var(--hcs-radius-md);
        border: 1px solid var(--hcs-bg-tertiary);
        margin-bottom: 1rem;
        border-left: 3px solid var(--hcs-accent);
    }

    .child-rule-row {
        background: var(--hcs-bg-primary);
        padding: 0.75rem;
        border-radius: var(--hcs-radius-sm);
        border: 1px solid var(--hcs-bg-tertiary);
        margin-bottom: 0.5rem;
        transition: border-color 0.2s;
    }

    .child-rule-row:hover {
        border-color: var(--hcs-accent);
    }

    .visual-label {
        font-weight: 500;
        color: var(--hcs-text-secondary);
        letter-spacing: 0.02em;
        text-transform: uppercase;
        font-size: 0.75rem;
        margin-bottom: 0.5rem;
        display: block;
    }

    /* ‚îÄ‚îÄ Input Group ‚îÄ‚îÄ */
    .modern-input-group {
        display: flex;
        border: 1px solid var(--hcs-bg-tertiary);
        border-radius: var(--hcs-radius-md);
        overflow: hidden;
        transition: border-color 0.2s;
        background: var(--hcs-bg-primary);
    }

    .modern-input-group:focus-within {
        border-color: var(--hcs-accent);
        box-shadow: 0 0 0 3px var(--hcs-accent-glow);
    }

    .modern-input-group .input-group-text {
        background: var(--hcs-bg-secondary);
        padding: 0.625rem 1rem;
        font-size: 0.875rem;
        color: var(--hcs-text-secondary);
        border-right: 1px solid var(--hcs-bg-tertiary);
        white-space: nowrap;
        display: flex;
        align-items: center;
    }

    .modern-input-group .form-input {
        border: none;
        box-shadow: none;
        border-radius: 0;
        padding-left: 1rem;
        background: transparent;
    }

    .modern-input-group .form-input:focus {
        box-shadow: none;
    }

    /* ‚îÄ‚îÄ Sandbox Enhancements ‚îÄ‚îÄ */
    .sandbox-card {
        backdrop-filter: blur(8px);
        background: rgba(30, 41, 59, 0.85);
        border: 1px solid rgba(51, 65, 85, 0.6);
    }

    #test_config {
        background-color: var(--hcs-bg-primary) !important;
        border: 1px solid var(--hcs-bg-tertiary) !important;
        tab-size: 4;
    }

    .match-line {
        background: rgba(59, 130, 246, 0.15);
        border-left: 3px solid var(--hcs-accent);
        padding-left: 0.5rem;
    }

    .sandbox-stats {
        display: flex;
        gap: 1rem;
        padding: 0.5rem 0;
        font-size: 0.75rem;
        color: var(--hcs-text-muted);
    }

    .sandbox-stats span {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="breadcrumbs">
    <a href="{{ url_for('web.dashboard') }}">Dashboard</a>
    <span class="sep">‚Ä∫</span>
    <a href="{{ url_for('web.rules_list') }}">Rules</a>
    <span class="sep">‚Ä∫</span>
    <span class="current">{% if rule %}Edit{% else %}New{% endif %}</span>
</div>
<div class="flex justify-between items-center mb-3">
    <div class="flex items-center gap-2">
        <a href="{{ url_for('web.rules_list') }}" class="btn btn-ghost btn-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6" />
            </svg>
        </a>
        <div>
            <h2 style="margin: 0;">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ø—Ä–∞–≤–∏–ª</h2>
            <p class="text-sm text-muted" style="margin: 0;">–°–æ–∑–¥–∞–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–æ–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</p>
        </div>
    </div>
</div>

<div class="builder-grid">
    <!-- Rule Form -->
    <div class="card fade-in">
        <div class="card-header">
            <h4 style="margin: 0;">–ù–∞—Å—Ç—Ä–æ–π–∫–∞</h4>
            <label class="toggle-switch" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤ —Ä–µ–∂–∏–º —Ä—É—á–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è JSON">
                <input type="checkbox" id="manualModeToggle" onchange="toggleManualMode()">
                <span class="toggle-slider"></span>
                <span class="text-xs font-bold text-muted uppercase">JSON Mode</span>
            </label>
        </div>

        <div class="card-body">
            <form id="ruleForm">
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞</label>
                    <input type="text" class="form-input" id="title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞–ø—Ä–µ—Ç Telnet"
                        style="font-size: 1.1rem;" required>
                </div>

                <div class="grid grid-2 gap-2 mb-2">
                    <div class="form-group">
                        <label class="form-label">–ü–æ–ª–∏—Ç–∏–∫–∞</label>
                        <select class="form-select" id="policy_id" required>
                            {% for policy in policies %}
                            <option value="{{ policy.id }}">{{ policy.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–í–µ–Ω–¥–æ—Ä</label>
                        <select class="form-select" id="vendor_code" required>
                            {% for vendor in vendors %}
                            <option value="{{ vendor.code }}">{{ vendor.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Severity -->
                <div class="form-group mb-3">
                    <label class="form-label">–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å</label>
                    <div class="severity-options">
                        <button type="button" class="severity-btn" data-severity="critical"
                            style="--color: #ef4444; --bg: rgba(239,68,68,0.12);" onclick="setSeverity(this)">üî¥
                            Critical</button>
                        <button type="button" class="severity-btn" data-severity="high"
                            style="--color: #f97316; --bg: rgba(249,115,22,0.12);" onclick="setSeverity(this)">üü†
                            High</button>
                        <button type="button" class="severity-btn active" data-severity="medium"
                            style="--color: #eab308; --bg: rgba(234,179,8,0.12);" onclick="setSeverity(this)">üü°
                            Medium</button>
                        <button type="button" class="severity-btn" data-severity="low"
                            style="--color: #3b82f6; --bg: rgba(59,130,246,0.12);" onclick="setSeverity(this)">üîµ
                            Low</button>
                        <button type="button" class="severity-btn" data-severity="info"
                            style="--color: #64748b; --bg: rgba(100,116,139,0.12);" onclick="setSeverity(this)">‚ö™
                            Info</button>
                    </div>
                    <input type="hidden" id="severity" value="medium">
                </div>

                <!-- Type Selector Cards -->
                <div class="form-group mb-3">
                    <label class="form-label">–¢–∏–ø –ø—Ä–æ–≤–µ—Ä–∫–∏</label>
                    <div class="type-cards-grid">
                        <div class="type-card active" data-type="simple_match" onclick="selectType(this)">
                            <svg class="type-card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5">
                                <circle cx="11" cy="11" r="8" />
                                <path d="M21 21l-4.35-4.35" />
                            </svg>
                            <div class="type-card-title">Simple Match</div>
                            <div class="type-card-desc">–ü–æ–∏—Å–∫ —Å—Ç—Ä–æ–∫–∏ –∏–ª–∏ regex</div>
                        </div>
                        <div class="type-card" data-type="block_match" onclick="selectType(this)">
                            <svg class="type-card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5">
                                <rect x="3" y="3" width="7" height="7" />
                                <rect x="14" y="3" width="7" height="7" />
                                <rect x="3" y="14" width="7" height="7" />
                                <path d="M14 17h7" />
                            </svg>
                            <div class="type-card-title">Block Match</div>
                            <div class="type-card-desc">–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –±–ª–æ–∫–∞ (interface, vlan...)</div>
                        </div>
                        <div class="type-card" data-type="structure_check" onclick="selectType(this)">
                            <svg class="type-card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5">
                                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" />
                                <polyline points="14 2 14 8 20 8" />
                                <path d="M12 18v-6" />
                                <path d="M9 15l3 3 3-3" />
                            </svg>
                            <div class="type-card-title">Structure Check</div>
                            <div class="type-card-desc">JMESPath –∑–∞–ø—Ä–æ—Å –∫ JSON/API</div>
                        </div>
                        <div class="type-card" data-type="version_check" onclick="selectType(this)">
                            <svg class="type-card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5">
                                <path d="M12 20V10" />
                                <path d="M18 20V4" />
                                <path d="M6 20v-4" />
                            </svg>
                            <div class="type-card-title">Version Check</div>
                            <div class="type-card-desc">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –ü–û</div>
                        </div>
                        <div class="type-card" data-type="textfsm_check" onclick="selectType(this)">
                            <svg class="type-card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5">
                                <rect x="3" y="3" width="18" height="18" rx="2" />
                                <path d="M3 9h18" />
                                <path d="M9 21V9" />
                            </svg>
                            <div class="type-card-title">TextFSM</div>
                            <div class="type-card-desc">–¢–∞–±–ª–∏—á–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –ø–æ —à–∞–±–ª–æ–Ω—É</div>
                        </div>
                        <div class="type-card" data-type="xml_check" onclick="selectType(this)">
                            <svg class="type-card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5">
                                <polyline points="16 18 22 12 16 6" />
                                <polyline points="8 6 2 12 8 18" />
                                <line x1="12" y1="2" x2="12" y2="22" stroke-dasharray="3 3" />
                            </svg>
                            <div class="type-card-title">XML / XPath</div>
                            <div class="type-card-desc">–ó–∞–ø—Ä–æ—Å –∫ XML-–∫–æ–Ω—Ñ–∏–≥—É</div>
                        </div>
                    </div>
                    <select class="form-select" id="logic_type" style="display:none;">
                        <option value="simple_match">Simple Match</option>
                        <option value="block_match">Block Match</option>
                        <option value="structure_check">Structure Check</option>
                        <option value="version_check">Version Check</option>
                        <option value="textfsm_check">TextFSM Check</option>
                        <option value="xml_check">XML Check</option>
                    </select>
                </div>

                <hr style="border: 0; border-top: 1px solid var(--hcs-bg-tertiary); margin: 1.5rem 0;" />

                <!-- VISUAL BUILDER UI -->
                <div id="visualBuilder" class="visual-builder-container mb-3">

                    <!-- 1. Simple Match -->
                    <div id="form_simple_match" class="logic-form" style="display: none;">
                        <div class="form-group mb-3">
                            <label class="step-label"><span class="step-num">1</span> –ò—Å–∫–æ–º—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω</label>
                            <div class="modern-input-group">
                                <span class="input-group-text">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </span>
                                <input type="text" class="form-input" id="sm_pattern"
                                    placeholder="e.g. ^service password-encryption">
                            </div>
                            <div class="field-hint">Regex: <code>^line vty</code> ‚Äî –Ω–∞—á–∞–ª–æ —Å—Ç—Ä–æ–∫–∏,
                                <code>transport input (ssh|none)</code> ‚Äî –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞
                            </div>
                        </div>
                        <div class="grid grid-2 gap-2">
                            <div class="form-group">
                                <label class="step-label"><span class="step-num">2</span> –°–æ—Å—Ç–æ—è–Ω–∏–µ</label>
                                <select class="form-select" id="sm_mode">
                                    <option value="must_exist">–î–æ–ª–∂–Ω–æ –±—ã—Ç—å (Required)</option>
                                    <option value="must_not_exist">–ó–∞–ø—Ä–µ—â–µ–Ω–æ (Forbidden)</option>
                                </select>
                            </div>
                            <div class="flex flex-col gap-2 justify-between" style="padding-top: 24px;">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="sm_regex" checked>
                                    <span class="toggle-slider"></span>
                                    <span class="text-sm">Regex</span>
                                </label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="sm_case">
                                    <span class="toggle-slider"></span>
                                    <span class="text-sm">Case Insensitive</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Block Match -->
                    <div id="form_block_match" class="logic-form" style="display: none;">
                        <div class="grid grid-2 gap-2 mb-2">
                            <div class="form-group">
                                <label class="step-label"><span class="step-num">1</span> –ù–∞—á–∞–ª–æ –±–ª–æ–∫–∞</label>
                                <input type="text" class="form-input" id="bm_parent" placeholder="^interface (Gi|Te)">
                                <div class="field-hint">Regex –¥–ª—è parent-—Å—Ç—Ä–æ–∫–∏: <code>^interface</code>,
                                    <code>^router ospf</code>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="step-label"><span class="step-num">2</span> –ö–æ–Ω–µ—Ü –±–ª–æ–∫–∞ <span
                                        class="text-muted"
                                        style="font-weight:normal;text-transform:none;">(opt.)</span></label>
                                <input type="text" class="form-input" id="bm_end" placeholder="^!">
                            </div>
                        </div>
                        <div class="form-group mb-3">
                            <label class="visual-label">–ò—Å–∫–ª—é—á–∏—Ç—å –±–ª–æ–∫–∏ (Filter)</label>
                            <input type="text" class="form-input" id="bm_exclude"
                                placeholder="e.g. description .*UPLINK.*">
                            <div class="field-hint">–ë–ª–æ–∫–∏ —Å —ç—Ç–∏–º –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º –±—É–¥—É—Ç –ø—Ä–æ–ø—É—â–µ–Ω—ã</div>
                        </div>
                        <div class="nested-group-container">
                            <label class="step-label mb-2"><span class="step-num">3</span> –í–ª–æ–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏</label>
                            <div id="bm_children_container" class="flex flex-col gap-2 mb-3"></div>
                            <button type="button" class="btn btn-secondary w-full" style="border-style: dashed;"
                                onclick="addBlockChildRow()">
                                + –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É
                            </button>
                        </div>
                        <div class="form-group">
                            <label class="visual-label">–õ–æ–≥–∏–∫–∞</label>
                            <select class="form-select" id="bm_logic">
                                <option value="ALL">ALL ‚Äî –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞—Å—Ç—å</option>
                                <option value="ANY">ANY ‚Äî –•–æ—Ç—è –±—ã –æ–¥–Ω–∞</option>
                            </select>
                        </div>
                    </div>

                    <!-- 3. Structure Check -->
                    <div id="form_structure_check" class="logic-form" style="display: none;">
                        <div class="form-group mb-3">
                            <label class="step-label"><span class="step-num">1</span> JMESPath Query</label>
                            <div class="modern-input-group">
                                <span class="input-group-text">$.</span>
                                <input type="text" class="form-input" id="sc_path"
                                    placeholder="network.interfaces[?name=='eth0'].enabled">
                            </div>
                            <div class="field-hint">–ü—Ä–∏–º–µ—Ä—ã: <code>security.firewall.enabled</code>,
                                <code>users[?role=='admin'] | length(@)</code>
                            </div>
                        </div>
                        <div class="grid grid-2 gap-2">
                            <div class="form-group">
                                <label class="step-label"><span class="step-num">2</span> –û–ø–µ—Ä–∞—Ç–æ—Ä</label>
                                <select class="form-select" id="sc_operator" onchange="toggleScValue()">
                                    <option value="eq">== –†–∞–≤–Ω–æ</option>
                                    <option value="neq">!= –ù–µ —Ä–∞–≤–Ω–æ</option>
                                    <option value="contains">‚àã –°–æ–¥–µ—Ä–∂–∏—Ç</option>
                                    <option value="exists">‚àÉ –°—É—â–µ—Å—Ç–≤—É–µ—Ç</option>
                                    <option value="not_exists">‚àÑ –ù–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç</option>
                                    <option value="gt">&gt; –ë–æ–ª—å—à–µ</option>
                                    <option value="lt">&lt; –ú–µ–Ω—å—à–µ</option>
                                </select>
                            </div>
                            <div class="form-group" id="sc_value_group">
                                <label class="step-label"><span class="step-num">3</span> –ó–Ω–∞—á–µ–Ω–∏–µ</label>
                                <input type="text" class="form-input" id="sc_value" placeholder="true">
                            </div>
                        </div>
                    </div>

                    <!-- 4. Version Check -->
                    <div id="form_version_check" class="logic-form" style="display: none;">
                        <div class="form-group mb-3">
                            <label class="step-label"><span class="step-num">1</span> Regex –ø–∞—Ç—Ç–µ—Ä–Ω –≤–µ—Ä—Å–∏–∏</label>
                            <div class="modern-input-group">
                                <span class="input-group-text">v</span>
                                <input type="text" class="form-input" id="vc_pattern"
                                    placeholder="version (\d+\.\d+\.\d+)">
                            </div>
                            <div class="field-hint">–ì—Ä—É–ø–ø–∞ –∑–∞—Ö–≤–∞—Ç–∞ <code>(\d+\.\d+)</code> –∏–∑–≤–ª–µ—á—ë—Ç –Ω–æ–º–µ—Ä –≤–µ—Ä—Å–∏–∏</div>
                        </div>
                        <div class="grid grid-2 gap-2">
                            <div class="form-group">
                                <label class="step-label"><span class="step-num">2</span> –û–ø–µ—Ä–∞—Ç–æ—Ä</label>
                                <select class="form-select" id="vc_operator">
                                    <option value="ge">>= –ë–æ–ª—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–æ</option>
                                    <option value="eq">== –†–∞–≤–Ω–æ</option>
                                    <option value="le">
                                        <= –ú–µ–Ω—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–æ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="step-label"><span class="step-num">3</span> –¢—Ä–µ–±—É–µ–º–∞—è –≤–µ—Ä—Å–∏—è</label>
                                <input type="text" class="form-input" id="vc_value" placeholder="15.2.4">
                            </div>
                        </div>
                    </div>

                    <!-- 5. TextFSM Check -->
                    <div id="form_textfsm_check" class="logic-form" style="display: none;">
                        <div class="form-group mb-3">
                            <label class="step-label"><span class="step-num">1</span> TextFSM —à–∞–±–ª–æ–Ω</label>
                            <textarea class="form-textarea font-mono text-xs" id="tfsm_template" rows="6"
                                placeholder="Value INTERFACE (\S+)&#10;Value STATUS (up|down)&#10;&#10;Start&#10;  ^${INTERFACE}\s+${STATUS} -> Record"></textarea>
                            <div class="field-hint">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π TextFSM —à–∞–±–ª–æ–Ω. –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ Value-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –ø—Ä–∞–≤–∏–ª–∞
                                –ø–∞—Ä—Å–∏–Ω–≥–∞.</div>
                        </div>
                        <div class="grid grid-2 gap-2 mb-2">
                            <div class="form-group">
                                <label class="step-label"><span class="step-num">2</span> –ö–æ–ª–æ–Ω–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏</label>
                                <input type="text" class="form-input" id="tfsm_column" placeholder="STATUS">
                                <div class="field-hint">–ò–º—è Value-–ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
                            </div>
                            <div class="form-group">
                                <label class="step-label"><span class="step-num">3</span> –û–ø–µ—Ä–∞—Ç–æ—Ä</label>
                                <select class="form-select" id="tfsm_operator">
                                    <option value="all_eq">–í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è ==</option>
                                    <option value="any_eq">–•–æ—Ç—è –±—ã –æ–¥–Ω–æ ==</option>
                                    <option value="none_eq">–ù–∏ –æ–¥–Ω–æ –Ω–µ ==</option>
                                    <option value="count_gt">–ö–æ–ª-–≤–æ —Å—Ç—Ä–æ–∫ ></option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="step-label"><span class="step-num">4</span> –û–∂–∏–¥–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</label>
                            <input type="text" class="form-input" id="tfsm_value" placeholder="up">
                        </div>
                    </div>

                    <!-- 6. XML/XPath Check -->
                    <div id="form_xml_check" class="logic-form" style="display: none;">
                        <div class="form-group mb-3">
                            <label class="step-label"><span class="step-num">1</span> XPath –≤—ã—Ä–∞–∂–µ–Ω–∏–µ</label>
                            <div class="modern-input-group">
                                <span class="input-group-text">XPath</span>
                                <input type="text" class="form-input" id="xml_xpath"
                                    placeholder="//system/services/ssh/protocol-version">
                            </div>
                            <div class="field-hint">–ü—Ä–∏–º–µ—Ä—ã:
                                <code>//interfaces/interface[@name='ge-0/0/0']/unit/family/inet</code>
                            </div>
                        </div>
                        <div class="form-group mb-3">
                            <label class="visual-label">Namespace prefix <span class="text-muted"
                                    style="font-weight:normal;text-transform:none;">(opt.)</span></label>
                            <input type="text" class="form-input" id="xml_ns"
                                placeholder="e.g. junos=http://xml.juniper.net/junos">
                            <div class="field-hint">–§–æ—Ä–º–∞—Ç: <code>prefix=uri</code>, —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö</div>
                        </div>
                        <div class="grid grid-2 gap-2">
                            <div class="form-group">
                                <label class="step-label"><span class="step-num">2</span> –û–ø–µ—Ä–∞—Ç–æ—Ä</label>
                                <select class="form-select" id="xml_operator" onchange="toggleXmlValue()">
                                    <option value="eq">== –†–∞–≤–Ω–æ</option>
                                    <option value="neq">!= –ù–µ —Ä–∞–≤–Ω–æ</option>
                                    <option value="contains">‚àã –°–æ–¥–µ—Ä–∂–∏—Ç</option>
                                    <option value="exists">‚àÉ –°—É—â–µ—Å—Ç–≤—É–µ—Ç</option>
                                    <option value="not_exists">‚àÑ –ù–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç</option>
                                </select>
                            </div>
                            <div class="form-group" id="xml_value_group">
                                <label class="step-label"><span class="step-num">3</span> –ó–Ω–∞—á–µ–Ω–∏–µ</label>
                                <input type="text" class="form-input" id="xml_value" placeholder="v2">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MANUAL JSON EDITOR -->
                <div class="form-group fade-in" id="jsonPayloadGroup" style="display: none;">
                    <label class="form-label font-mono text-xs text-muted mb-2 block">RAW JSON PAYLOAD</label>
                    <textarea class="form-textarea payload-editor" id="logic_payload" required></textarea>
                </div>

                <div class="grid grid-2 gap-2 mt-3">
                    <div class="form-group">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-textarea" id="description" rows="2" placeholder="–ö–æ–Ω—Ç–µ–∫—Å—Ç..."
                            style="font-family: inherit;"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Remediation</label>
                        <textarea class="form-textarea" id="remediation" rows="2" placeholder="–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å..."
                            style="font-family: inherit;"></textarea>
                    </div>
                </div>
            </form>
        </div>
        <div class="card-footer flex justify-between">
            <button class="btn btn-ghost" type="button" onclick="history.back()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" type="button" onclick="saveRule()">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ
            </button>
        </div>
    </div>

    <!-- Live Sandbox -->
    <div class="card fade-in sandbox-card"
        style="animation-delay: 100ms; height: fit-content; position: sticky; top: 1rem;">
        <div class="card-header flex justify-between items-center pb-2">
            <div>
                <h4 class="m-0">Live Sandbox</h4>
                <p class="text-xs text-muted m-0">–ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª–æ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å</p>
            </div>
            <button class="btn btn-success btn-sm flex items-center gap-2" type="button" onclick="testRule()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3" />
                </svg>
                Run Test
            </button>
        </div>
        <div class="card-body">
            <div class="flex justify-between items-center mb-2">
                <div class="sandbox-stats" id="sandboxStats">
                    <span>–°—Ç—Ä–æ–∫: <strong id="statLines">0</strong></span>
                    <span>–ë–ª–æ–∫–æ–≤: <strong id="statBlocks">0</strong></span>
                </div>
                <button class="btn btn-link" type="button" onclick="loadSampleConfig()">
                    –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–º–µ—Ä
                </button>
            </div>
            <div class="form-group mb-4">
                <textarea class="form-textarea font-mono text-xs leading-relaxed" id="test_config" rows="18"
                    placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞..." oninput="updateSandboxStats()"
                    style="background: var(--hcs-bg-tertiary); border: none;"></textarea>
            </div>

            <div id="testResult" class="test-result p-3 rounded"
                style="display: none; background: var(--hcs-bg-primary); border: 1px solid var(--hcs-bg-tertiary);">
                <label class="text-xs font-bold uppercase text-muted mb-2 block">–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</label>
                <div id="testResultContent"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initial templates for JSON Mode fallback
    const PAYLOAD_TEMPLATES = {
        simple_match: { pattern: "^service password-encryption", match_mode: "must_exist", is_regex: true },
        block_match: { parent_block_start: "^interface Gi", child_rules: [{ pattern: "no ip redirects", mode: "must_exist" }] },
        structure_check: { path: "network.interfaces", operator: "eq", value: "up" },
        version_check: { pattern: "version (\\d+)", operator: "ge", value: "15.0" },
        textfsm_check: { template: "", column: "STATUS", operator: "all_eq", value: "up" },
        xml_check: { xpath: "//system/services/ssh", operator: "exists" }
    };

    let isManualMode = false;

    // --- Type Card & Severity Selectors ---

    function selectType(card) {
        document.querySelectorAll('.type-card').forEach(c => c.classList.remove('active'));
        card.classList.add('active');
        const type = card.dataset.type;
        document.getElementById('logic_type').value = type;
        updateBuilderMode();
    }

    function setSeverity(btn) {
        document.querySelectorAll('.severity-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('severity').value = btn.dataset.severity;
    }

    function updateSandboxStats() {
        const text = document.getElementById('test_config').value;
        const lines = text ? text.split('\n').length : 0;
        const blocks = text ? (text.match(/^\S/gm) || []).length : 0;
        document.getElementById('statLines').textContent = lines;
        document.getElementById('statBlocks').textContent = blocks;
    }

    function toggleXmlValue() {
        const op = document.getElementById('xml_operator').value;
        const noValOps = ['exists', 'not_exists'];
        document.getElementById('xml_value_group').style.display = noValOps.includes(op) ? 'none' : 'block';
        syncVisualToJson();
    }

    // --- Core Lifecycle ---

    function initBuilder() {
        updateBuilderMode();

        // Listeners for auto-updating JSON from Visual Fields
        const inputs = document.querySelectorAll('#visualBuilder input, #visualBuilder select');
        inputs.forEach(input => {
            input.addEventListener('input', syncVisualToJson);
        });
    }

    function toggleManualMode() {
        isManualMode = document.getElementById('manualModeToggle').checked;
        const visualBuilder = document.getElementById('visualBuilder');
        const jsonGroup = document.getElementById('jsonPayloadGroup');

        if (isManualMode) {
            visualBuilder.style.display = 'none';
            jsonGroup.style.display = 'block';
        } else {
            // Try to parse JSON back to visual
            trySyncJsonToVisual();
            visualBuilder.style.display = 'block';
            jsonGroup.style.display = 'none';
        }
    }

    function updateBuilderMode() {
        const type = document.getElementById('logic_type').value;

        // Hide all forms
        document.querySelectorAll('.logic-form').forEach(el => el.style.display = 'none');

        // Show specific form
        const formId = `form_${type}`;
        const form = document.getElementById(formId);
        if (form) {
            form.style.display = 'block';
        }

        // Sync type cards
        document.querySelectorAll('.type-card').forEach(c => {
            c.classList.toggle('active', c.dataset.type === type);
        });

        // Initialize default JSON if empty
        const jsonVal = document.getElementById('logic_payload').value.trim();
        if (!jsonVal && PAYLOAD_TEMPLATES[type]) {
            document.getElementById('logic_payload').value = JSON.stringify(PAYLOAD_TEMPLATES[type], null, 2);
            trySyncJsonToVisual(); // Populate visual fields from template
        }
    }

    // --- Sync Logic: Visual -> JSON ---

    function syncVisualToJson() {
        if (isManualMode) return;

        const type = document.getElementById('logic_type').value;
        let payload = {};

        try {
            if (type === 'simple_match') {
                payload = {
                    pattern: document.getElementById('sm_pattern').value,
                    match_mode: document.getElementById('sm_mode').value,
                    is_regex: document.getElementById('sm_regex').checked,
                    case_insensitive: document.getElementById('sm_case').checked
                };
            } else if (type === 'block_match') {
                payload = {
                    parent_block_start: document.getElementById('bm_parent').value,
                    parent_block_end: document.getElementById('bm_end').value || null,
                    exclude_filter: document.getElementById('bm_exclude').value || null,
                    logic: document.getElementById('bm_logic').value,
                    child_rules: getBlockChildRules()
                };
            } else if (type === 'structure_check') {
                payload = {
                    path: document.getElementById('sc_path').value,
                    operator: document.getElementById('sc_operator').value,
                    value: document.getElementById('sc_value').value
                };
                if (payload.operator.includes('exists')) delete payload.value;
            } else if (type === 'version_check') {
                payload = {
                    pattern: document.getElementById('vc_pattern').value,
                    operator: document.getElementById('vc_operator').value,
                    value: document.getElementById('vc_value').value,
                    version_group: 1
                };
            } else if (type === 'textfsm_check') {
                payload = {
                    template: document.getElementById('tfsm_template').value,
                    column: document.getElementById('tfsm_column').value,
                    operator: document.getElementById('tfsm_operator').value,
                    value: document.getElementById('tfsm_value').value
                };
            } else if (type === 'xml_check') {
                payload = {
                    xpath: document.getElementById('xml_xpath').value,
                    operator: document.getElementById('xml_operator').value,
                    value: document.getElementById('xml_value').value
                };
                const ns = document.getElementById('xml_ns').value.trim();
                if (ns) payload.namespaces = ns;
                if (['exists', 'not_exists'].includes(payload.operator)) delete payload.value;
            } else {
                return;
            }

            document.getElementById('logic_payload').value = JSON.stringify(payload, null, 2);
        } catch (e) {
            console.error("Sync error", e);
        }
    }

    // --- Sync Logic: JSON -> Visual ---

    function trySyncJsonToVisual() {
        const type = document.getElementById('logic_type').value;
        const jsonStr = document.getElementById('logic_payload').value;

        try {
            const payload = JSON.parse(jsonStr);

            if (type === 'simple_match') {
                document.getElementById('sm_pattern').value = payload.pattern || '';
                document.getElementById('sm_mode').value = payload.match_mode || 'must_exist';
                document.getElementById('sm_regex').checked = payload.is_regex !== false; // Default true if undefined
                document.getElementById('sm_case').checked = !!payload.case_insensitive;
            } else if (type === 'block_match') {
                document.getElementById('bm_parent').value = payload.parent_block_start || '';
                document.getElementById('bm_end').value = payload.parent_block_end || '';
                document.getElementById('bm_exclude').value = payload.exclude_filter || '';
                document.getElementById('bm_logic').value = payload.logic || 'ALL';

                // Rebuild children
                const container = document.getElementById('bm_children_container');
                container.innerHTML = '';
                if (payload.child_rules && Array.isArray(payload.child_rules)) {
                    payload.child_rules.forEach(rule => addBlockChildRow(rule.pattern, rule.mode));
                } else {
                    addBlockChildRow(); // Add empty row
                }
            } else if (type === 'structure_check') {
                document.getElementById('sc_path').value = payload.path || '';
                document.getElementById('sc_operator').value = payload.operator || 'eq';
                document.getElementById('sc_value').value = payload.value || '';
                toggleScValue();
            } else if (type === 'version_check') {
                document.getElementById('vc_pattern').value = payload.pattern || '';
                document.getElementById('vc_operator').value = payload.operator || 'ge';
                document.getElementById('vc_value').value = payload.value || '';
            } else if (type === 'textfsm_check') {
                document.getElementById('tfsm_template').value = payload.template || '';
                document.getElementById('tfsm_column').value = payload.column || '';
                document.getElementById('tfsm_operator').value = payload.operator || 'all_eq';
                document.getElementById('tfsm_value').value = payload.value || '';
            } else if (type === 'xml_check') {
                document.getElementById('xml_xpath').value = payload.xpath || '';
                document.getElementById('xml_ns').value = payload.namespaces || '';
                document.getElementById('xml_operator').value = payload.operator || 'eq';
                document.getElementById('xml_value').value = payload.value || '';
                toggleXmlValue();
            }

        } catch (e) {
            console.warn("Could not parse JSON to Visual", e);
            // Don't clear fields, just fail silently as user might be typing invalid JSON
        }
    }

    // --- Helper Functions ---

    function addBlockChildRow(pattern = '', mode = 'must_exist') {
        const container = document.getElementById('bm_children_container');
        const div = document.createElement('div');
        div.className = 'child-rule-row grid grid-2 gap-2 items-center';
        div.style.gridTemplateColumns = '2fr 1fr auto';

        div.innerHTML = `
            <input type="text" class="form-input bm-child-pattern" placeholder="Pattern inside block" value="${pattern.replace(/"/g, '&quot;')}" oninput="syncVisualToJson()">
            <select class="form-select bm-child-mode" onchange="syncVisualToJson()">
                <option value="must_exist" ${mode === 'must_exist' ? 'selected' : ''}>Must Exist</option>
                <option value="must_not_exist" ${mode === 'must_not_exist' ? 'selected' : ''}>Forbidden</option>
            </select>
            <button type="button" class="btn btn-ghost btn-sm text-danger h-full flex items-center justify-center aspect-square" onclick="this.parentElement.remove(); syncVisualToJson()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
        `;
        container.appendChild(div);

        // Add listeners to new elements
        div.querySelectorAll('input, select').forEach(el => el.addEventListener('input', syncVisualToJson));
        syncVisualToJson();
    }

    function getBlockChildRules() {
        const rows = document.querySelectorAll('#bm_children_container > div');
        return Array.from(rows).map(row => ({
            pattern: row.querySelector('.bm-child-pattern').value,
            mode: row.querySelector('.bm-child-mode').value
        })).filter(r => r.pattern.trim() !== '');
    }

    function toggleScValue() {
        const op = document.getElementById('sc_operator').value;
        const noValOps = ['exists', 'not_exists'];
        document.getElementById('sc_value_group').style.display = noValOps.includes(op) ? 'none' : 'block';
        syncVisualToJson();
    }

    function loadSampleConfig() {
        const conf = `! Example Cisco IOS Config
version 15.2
service timestamps debug datetime msec
service timestamps log datetime msec
no service password-encryption
!
hostname Router01
!
interface GigabitEthernet1
 description EXTERNAL_UPLINK
 ip address 192.168.1.1 255.255.255.0
 no ip redirects
 no ip proxy-arp
 negotiation auto
!
interface GigabitEthernet2
 description INTERNAL_LAN
 ip address 10.0.0.1 255.255.255.0
 ip proxy-arp
!
line vty 0 4
 transport input ssh
!
end`;
        document.getElementById('test_config').value = conf;
    }

    // --- Existing API Functions (modified) ---

    async function testRule() {
        // Ensure JSON is up to date (if in visual mode)
        syncVisualToJson();

        const config = document.getElementById('test_config').value;
        if (!config.trim()) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏', 'warning');
            loadSampleConfig();
            return;
        }

        const logicType = document.getElementById('logic_type').value;
        let logicPayload;

        try {
            logicPayload = JSON.parse(document.getElementById('logic_payload').value);
        } catch (e) {
            showNotification('–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π Payload', 'danger');
            return;
        }

        const resultDiv = document.getElementById('testResult');
        const resultContent = document.getElementById('testResultContent');

        resultDiv.style.display = 'block';
        resultContent.innerHTML = '<div class="text-sm text-muted animate-pulse">Running checks...</div>';

        try {
            const response = await fetch('/api/test/rule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    config: config,
                    logic_type: logicType,
                    logic_payload: logicPayload
                })
            });

            const data = await response.json();

            let html = '';
            if (data.passed) {
                html = `<div class="alert alert-success flex items-center gap-2">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                <strong>PASS:</strong> ${data.message}
            </div>`;
            } else if (data.status === 'ERROR') {
                html = `<div class="alert alert-warning">
                <strong>‚ö† ERROR:</strong> ${data.message}
            </div>`;
            } else {
                html = `<div class="alert alert-danger">
                <div class="flex items-center gap-2 mb-1">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                    <strong>FAIL:</strong> ${data.message}
                </div>
            </div>`;
                if (data.diff_data) {
                    html += `<pre class="mt-2" style="background: var(--hcs-bg-primary); padding: 0.5rem; font-size: 0.75rem;">${data.diff_data}</pre>`;
                }
            }
            resultContent.innerHTML = html;

        } catch (e) {
            resultContent.innerHTML = `<div class="text-danger">–û—à–∏–±–∫–∞: ${e.message}</div>`;
        }
    }

    async function saveRule() {
        syncVisualToJson();

        let logicPayload;
        try {
            logicPayload = JSON.parse(document.getElementById('logic_payload').value);
        } catch (e) {
            showNotification('–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON –≤ payload', 'danger');
            return;
        }

        const rule = {
            title: document.getElementById('title').value,
            policy_id: document.getElementById('policy_id').value,
            vendor_code: document.getElementById('vendor_code').value,
            logic_type: document.getElementById('logic_type').value,
            logic_payload: logicPayload,
            severity: document.getElementById('severity').value,
            description: document.getElementById('description').value,
            remediation: document.getElementById('remediation').value
        };

        if (!rule.title) return showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'warning');

        try {
            const url = window.location.search.includes('edit')
                ? `/api/rules/${new URLSearchParams(window.location.search).get('edit')}`
                : '/api/rules';
            const method = window.location.search.includes('edit') ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(rule)
            });

            const data = await response.json();

            if (response.ok) {
                showNotification('–ü—Ä–∞–≤–∏–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!', 'success');
                setTimeout(() => window.location.href = '/rules', 1000);
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'danger');
            }
        } catch (e) {
            showNotification('–û—à–∏–±–∫–∞: ' + e.message, 'danger');
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
        initBuilder();
        updateSandboxStats();

        // Check for edit/clone params
        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('edit') || urlParams.get('clone');

        if (editId) {
            try {
                const response = await fetch(`/api/rules/${editId}`);
                if (response.ok) {
                    const rule = await response.json();

                    document.getElementById('title').value = rule.title + (urlParams.get('clone') ? " (Copy)" : "");
                    document.getElementById('policy_id').value = rule.policy_id;
                    document.getElementById('vendor_code').value = rule.vendor_code;
                    document.getElementById('logic_type').value = rule.logic_type;
                    document.getElementById('description').value = rule.description || '';
                    document.getElementById('remediation').value = rule.remediation || '';

                    // Sync severity
                    if (rule.severity) {
                        document.getElementById('severity').value = rule.severity;
                        document.querySelectorAll('.severity-btn').forEach(b => {
                            b.classList.toggle('active', b.dataset.severity === rule.severity);
                        });
                    }

                    // Sync type card
                    document.querySelectorAll('.type-card').forEach(c => {
                        c.classList.toggle('active', c.dataset.type === rule.logic_type);
                    });

                    if (rule.logic_payload) {
                        document.getElementById('logic_payload').value = JSON.stringify(rule.logic_payload, null, 2);
                        updateBuilderMode(); // Re-trigger visual sync
                    }
                }
            } catch (e) { console.error(e); }
        } else {
            // New rule defaults
            loadSampleConfig();
            updateSandboxStats();
        }
    });
</script>
{% endblock %}